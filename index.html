<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stations Popup (with hit layer)</title>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css">
  <style>html,body,#map{height:100%;margin:0}.mapboxgl-popup{max-width:240px;font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}</style>
</head>
<body>
  <div id="map"></div>
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <script>
    const ACCESS_TOKEN = 'pk.eyJ1IjoieXVpY2hpcm9mdW1hIiwiYSI6ImNtYTZqazZtZjBzNzMya3E0NjRjZmRsOGgifQ.eq7usBrMNDOipZWRZCl8oA';
    const STYLE_URL    = 'mapbox://styles/yuichirofuma/cme6zyp2d00s001rebyiffeqy';
    const TARGET_LAYER_ID = 'station_layer';    // StudioのレイヤID
    const HIT_LAYER_ID    = 'station_hit_layer';// 追加する当たり判定レイヤID

    mapboxgl.accessToken = ACCESS_TOKEN;
    const map = new mapboxgl.Map({
      container: 'map',
      style: STYLE_URL,
      center: [139.7671, 35.6812],
      zoom: 13
    });
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', () => {
      const target = map.getLayer(TARGET_LAYER_ID);
      if (!target) {
        console.error('target layer not found:', TARGET_LAYER_ID);
        return;
      }
      // station_layer が参照している source / source-layer を取得
      const src = target.source;
      const srcLayer = target['source-layer']; // vector tilesetなら定義される

      // 既にあれば消して作り直し
      if (map.getLayer(HIT_LAYER_ID)) map.removeLayer(HIT_LAYER_ID);

      // ほぼ透明な円を描く（レンダリング対象にするため 0 にはしない）
      const paint = {
        'circle-radius': 24,
        'circle-color': 'rgba(0,0,0,0.01)',
        'circle-stroke-width': 0
      };

      // target の直上に差し込む
      const beforeId = TARGET_LAYER_ID;

      const layerDef = {
        id: HIT_LAYER_ID,
        type: 'circle',
        source: src,
        paint
      };
      if (srcLayer) layerDef['source-layer'] = srcLayer; // vector の場合に必要
      // （任意）駅だけに限定するフィルタがあるならセット
      // layerDef.filter = ['has','station_name'];

      map.addLayer(layerDef, beforeId);

      // ホバー時のカーソル
      map.on('mousemove', (e) => {
        const feats = map.queryRenderedFeatures(e.point, { layers: [HIT_LAYER_ID] });
        map.getCanvas().style.cursor = feats.length ? 'pointer' : '';
      });

      // クリック → ポップアップ
      map.on('click', (e) => {
        const feats = map.queryRenderedFeatures(e.point, { layers: [HIT_LAYER_ID] });
        if (!feats.length) return;
        const f = feats[0], p = f.properties || {};
        const coords = f.geometry.type==='Point' ? f.geometry.coordinates.slice() : e.lngLat.toArray();
        const name = p.station_name || p.name || '駅';
        const yomi = p.station_yomi ? `（${p.station_yomi}）` : '';
        const line = p.line ? `<div>路線：${p.line}</div>` : '';
        new mapboxgl.Popup().setLngLat(coords).setHTML(`<strong>${name}</strong>${yomi}${line}`).addTo(map);
      });

      console.log('[hit-layer added]', {src, srcLayer});
    });

    map.on('error', e => console.error('[map.error]', e?.error||e));
  </script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mapbox Safe Loader</title>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css?v=5">
<style>html,body,#map{height:100%;margin:0}#log{position:fixed;top:8px;left:8px;background:#0009;color:#fff;padding:8px 10px;border-radius:8px;font:12px/1.4 ui-sans-serif;z-index:10;max-width:46ch}</style>
</head>
<body>
<div id="log">loading…</div>
<div id="map"></div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js?v=5"></script>
<script>
const ACCESS_TOKEN='pk.eyJ1IjoieXVpY2hpcm9mdW1hIiwiYSI6ImNtYTZqazZtZjBzNzMya3E0NjRjZmRsOGgifQ.eq7usBrMNDOipZWRZCl8oA';
const STYLE_USER='yuichirofuma';
const STYLE_ID  ='cme6zyp2d00s001rebyiffeqy'; // StudioのPublish画面で再確認
const CUSTOM    = `https://api.mapbox.com/styles/v1/${STYLE_USER}/${STYLE_ID}?access_token=${ACCESS_TOKEN}&v=5`;
const FALLBACK  = `https://api.mapbox.com/styles/v1/mapbox/streets-v12?access_token=${ACCESS_TOKEN}`;

const log = (m)=>document.getElementById('log').innerHTML = m;
window.onerror=(m,s,l,c,e)=>console.error('[onerror]',m,s,l,c,e);
window.onunhandledrejection=e=>console.error('[unhandledrejection]',e.reason||e);

mapboxgl.accessToken = ACCESS_TOKEN;

// まずカスタムスタイルで試す→失敗したら既製に切替
let styleURL = CUSTOM;
const map = new mapboxgl.Map({
  container:'map', style: styleURL, center:[139.7671,35.6812], zoom:12, clickTolerance:12
});
map.addControl(new mapboxgl.NavigationControl());

let switched = false;
map.on('error', (e)=>{
  const msg = (e?.error?.message||'')+'';
  console.error('[map.error]', e?.error||e);
  if(!switched){
    switched = true;
    styleURL = FALLBACK;
    log(`<b>style error</b><div>${msg}</div><div>→ fallbackに切替中…</div>`);
    map.setStyle(styleURL);
  }else{
    log(`<b>fallbackでも失敗</b><div>${msg}</div>`);
  }
});
map.on('style.load', ()=>{
  log(`<b>style loaded</b><div>${styleURL.includes('mapbox/streets')?'(fallback)':'(custom)'}</div>`);
});
</script>
</body>
</html>

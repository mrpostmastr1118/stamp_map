<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Stations Popup (tap-friendly)</title>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css">
<style>
  html,body,#map{height:100%;margin:0}
  /* モバイルでブラウザ側のジェスチャ優先を弱める */
  #map { touch-action: none; }
  .mapboxgl-popup{max-width:240px;font:14px/1.4 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
</style>
</head>
<body>
<div id="map"></div>
<script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
<script>
const ACCESS_TOKEN = 'pk.eyJ1IjoieXVpY2hpcm9mdW1hIiwiYSI6ImNtYTZqazZtZjBzNzMya3E0NjRjZmRsOGgifQ.eq7usBrMNDOipZWRZCl8oA';
const STYLE_URL    = 'mapbox://styles/yuichirofuma/cme6zyp2d00s001rebyiffeqy';
const TARGET_LAYER_ID = 'station_layer';
const HIT_LAYER_ID    = 'station_hit_layer';

mapboxgl.accessToken = ACCESS_TOKEN;
const map = new mapboxgl.Map({
  container: 'map',
  style: STYLE_URL,
  center: [139.7671, 35.6812],
  zoom: 13,                // まずは描画が出やすいズームに
  clickTolerance: 12       // ← 重要：ちょい動いてもクリック扱い
});
map.addControl(new mapboxgl.NavigationControl());

// ヒットレイヤ追加（ほぼ透明の円）
map.on('load', () => {
  const t = map.getLayer(TARGET_LAYER_ID);
  if (!t) { console.error('target layer not found:', TARGET_LAYER_ID); return; }

  // レイヤの表示レンジを広げる
  map.setLayerZoomRange(TARGET_LAYER_ID, 0, 24);
  try {
    map.setLayoutProperty(TARGET_LAYER_ID, 'icon-allow-overlap', true);
    map.setLayoutProperty(TARGET_LAYER_ID, 'text-allow-overlap', true);
  } catch(e) {}

  const src = t.source, srcLayer = t['source-layer'];
  if (map.getLayer(HIT_LAYER_ID)) map.removeLayer(HIT_LAYER_ID);

  const hit = {
    id: HIT_LAYER_ID,
    type: 'circle',
    source: src,
    paint: { 'circle-radius': 26, 'circle-color': 'rgba(0,0,0,0.01)' }
  };
  if (srcLayer) hit['source-layer'] = srcLayer;
  map.addLayer(hit, TARGET_LAYER_ID);

  const openPopup = (lngLat, props) => {
    const p = props || {};
    const name = p.station_name || p.name || '駅';
    const yomi = p.station_yomi ? `（${p.station_yomi}）` : '';
    const line = p.line ? `<div>路線：${p.line}</div>` : '';
    new mapboxgl.Popup().setLngLat(lngLat).setHTML(`<strong>${name}</strong>${yomi}${line}`).addTo(map);
  };

  // ホバーで手カーソル
  map.on('mousemove', (e) => {
    const feats = map.queryRenderedFeatures(e.point, { layers: [HIT_LAYER_ID] });
    map.getCanvas().style.cursor = feats.length ? 'pointer' : '';
  });

  // クリック（マウス）
  map.on('click', (e) => {
    const feats = map.queryRenderedFeatures(e.point, { layers: [HIT_LAYER_ID] });
    if (!feats.length) return;
    const f = feats[0];
    const lngLat = f.geometry.type==='Point' ? f.geometry.coordinates.slice() : e.lngLat.toArray();
    openPopup(lngLat, f.properties);
  });

  // タップ（モバイル）— クリックと同処理
  map.on('touchend', (e) => {
    if (!e.points || !e.points.length) return;
    const feats = map.queryRenderedFeatures(e.points[0], { layers: [HIT_LAYER_ID] });
    if (!feats.length) return;
    const f = feats[0];
    const lngLat = f.geometry.type==='Point' ? f.geometry.coordinates.slice() : [e.lngLat.lng, e.lngLat.lat];
    openPopup(lngLat, f.properties);
  });
});

map.on('error', e => console.error('[map.error]', e?.error||e));
</script>
</body>
</html>
